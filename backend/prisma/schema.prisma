// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema
// Force update

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

// Battle.net OAuth User Model
model User {
  id              Int         @id @default(autoincrement())
  battleNetId     String      @unique
  name            String      @map("battletag")
  accessToken     String?
  refreshToken    String?
  tokenExpiresAt  DateTime?
  discordId       String?     @unique
  discordTag      String?
  lastLogin       DateTime    @default(now())
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  characters      Character[]
  guildMemberships UserGuild[]
  streams         Stream[]
  
  @@map("users")
}

// Character Model für Main/Twink Verwaltung
model Character {
  id              Int         @id @default(autoincrement())
  userId          Int?        // Optional, da Roster-Chars keinem User gehören müssen
  battleNetId     String?     @unique
  name            String
  realm           String
  level           Int         @default(1)
  class           String      // Klassenname (Warrior, Mage, etc.)
  classId         Int?        // Battle.net Class ID für sprachunabhängige Logik
  race            String      // Rassenname (Human, Orc, etc.)
  faction         String      // Alliance/Horde
  gender          String?     // Geschlecht
  isMain          Boolean     @default(false)
  isFavorite      Boolean     @default(false)
  isActive        Boolean     @default(true)
  role            String?     // Tank/DPS/Healer
  averageItemLevel Int?       // Aktuelles Itemlevel
  mythicRating    Float?      // Blizzard Mythic Rating (RIO Equivalent)
  raidProgress    String?     // Raid Fortschritt (z.B. 8/8 H)
  rank            Int?        // Gildenrang (0-9)
  lastSync        DateTime    @default(now())
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  guildId         Int?
  
  // Relations
  user            User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  guild           Guild?      @relation(fields: [guildId], references: [id])
  mythicKeys      MythicKey[]
  mythicSignups   MythicKeySignup[]
  attendances     Attendance[]
  
  // Unique Constraint für Name + Realm
  @@unique([name, realm])
  @@map("characters")
}

// Guild Model
model Guild {
  id              Int         @id @default(autoincrement())
  name            String      @unique
  realm           String
  faction         String      // Alliance/Horde
  description     String?
  lastSync        DateTime    @default(now())
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  characters      Character[]
  members         UserGuild[]
  raids           Raid[]
  messages        GuildChat[]
  rosters         Roster[]
  
  // Permissions & Ranks
  adminRanks      Int[]       @default([0]) // Standardmäßig hat nur Gildenleiter (0) Admin-Rechte
  visibleRanks    Int[]       @default([5, 7]) // Ränge, die im Roster angezeigt werden
  ranks           Json?       // Speichert Blizzard Ranks (id, name, order)
  
  // Main Roster Overrides
  mainRosterIncludedCharacterIds Int[] @default([]) // Characters manually added to Main Roster
  mainRosterExcludedCharacterIds Int[] @default([]) // Characters manually hidden from Main Roster
  
  @@map("guilds")
}

// Guild Chat History
model GuildChat {
  id        Int      @id @default(autoincrement())
  guildId   Int
  sender    String
  content   String
  timestamp DateTime @default(now())

  guild     Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@index([guildId])
  @@map("guild_chats")
}

// Roster Model für Gruppen-Definitionen
model Roster {
  id              Int         @id @default(autoincrement())
  guildId         Int
  name            String
  allowedRanks        Int[]       @default([]) // Ranks that belong to this roster
  excludedCharacterIds Int[]       @default([]) // Manually excluded characters
  includedCharacterIds Int[]       @default([]) // Manually included characters (even if rank doesn't match)
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  
  // Relations
  guild           Guild       @relation(fields: [guildId], references: [id], onDelete: Cascade)
  raids           Raid[]
  
  @@map("rosters")
}

// User-Guild Membership (für Gildenmitgliedschaft)
model UserGuild {
  id              Int         @id @default(autoincrement())
  userId          Int
  guildId         Int
  rank            Int         @default(0)
  joinedAt        DateTime    @default(now())
  
  // Relations
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  guild           Guild       @relation(fields: [guildId], references: [id], onDelete: Cascade)
  
  @@unique([userId, guildId])
  @@map("user_guilds")
}

// Raid Model für Raid-Planung
model Raid {
  id              Int         @id @default(autoincrement())
  guildId         Int
  rosterId        Int?        // Optionaler Link zu einem speziellen Roster
  title           String
  description     String?
  startTime       DateTime
  endTime         DateTime?
  maxPlayers      Int         @default(20)
  difficulty      String      // Normal/Heroic/Mythic
  status          String      @default("scheduled") // scheduled/ongoing/completed/cancelled
  recruitmentType String      @default("everyone") // everyone/main_only
  allowedRanks    Int[]       @default([]) // Ranks allowed to signup (empty = everyone)
  recurringId     String?     // UUID for group of recurring events
  imageUrl        String?     // Background image for the raid card
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  guild           Guild       @relation(fields: [guildId], references: [id], onDelete: Cascade)
  roster          Roster?     @relation(fields: [rosterId], references: [id])
  attendances     Attendance[]
  
  @@map("raids")
}

// Attendance Model für Raid-Teilnahme
model Attendance {
  id              Int         @id @default(autoincrement())
  raidId          Int
  characterId     Int
  status          String      @default("unknown") // attending/not_attending/late/tentative
  comment         String?
  roleSlot        String      @default("main") // main/twink1/twink2/twink3
  isConfirmed     Boolean     @default(false)
  signedUpAt      DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  raid            Raid        @relation(fields: [raidId], references: [id], onDelete: Cascade)
  character       Character   @relation(fields: [characterId], references: [id], onDelete: Cascade)
  
  @@unique([raidId, characterId])
  @@map("attendances")
}

// Mythic Key Model für Mythic+ Verfolgung
model MythicKey {
  id              Int         @id @default(autoincrement())
  characterId     Int
  dungeon         String
  level           Int
  affixes         String      // JSON Array mit Affix-IDs
  completed       Boolean     @default(false)
  completedAt     DateTime?
  weeklyBest      Boolean     @default(false)
  isFromBag       Boolean     @default(false) // Ob der Key aus dem Inventar (Addon) kommt oder Blizzard API (Best Run)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  character       Character   @relation(fields: [characterId], references: [id], onDelete: Cascade)
  signups         MythicKeySignup[]
  
  @@map("mythic_keys")
}

// Mythic Key Signup Model
model MythicKeySignup {
  id              Int         @id @default(autoincrement())
  keyId           Int
  characterId     Int
  status          String      @default("pending") // pending/accepted/declined
  message         String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  key             MythicKey   @relation(fields: [keyId], references: [id], onDelete: Cascade)
  character       Character   @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([keyId, characterId])
  @@map("mythic_key_signups")
}

// Stream Model für Gilden-Streams
model Stream {
  id              Int         @id @default(autoincrement())
  userId          Int
  title           String
  description     String?
  platform        String      // twitch/youtube/etc
  streamUrl       String
  isLive          Boolean     @default(false)
  isPublic        Boolean     @default(true)
  accessCode      String?     // Für private Streams
  viewerCount     Int         @default(0)
  startedAt       DateTime?
  endedAt         DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("streams")
}